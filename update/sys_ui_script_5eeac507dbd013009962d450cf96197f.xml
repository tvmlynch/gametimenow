<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_ui_script">
    <sys_ui_script action="INSERT_OR_UPDATE">
        <active>true</active>
        <description>In the UI Script (create the Angular Controller module and define some of the table URL API calls to be used. for the SN BBall UI Page&#13;
create a function that gets the next upcoming game.&#13;
In the UI Script, implement the rest of the REST based functions to use in the UI page. For this application, we need to be able to fetch the list of players for a game, and the optin-in/opt-out status of each of those players. We will also want to be able to change that status for the current viewer.</description>
        <global>false</global>
        <name>sn_bball.BBallPlayers</name>
        <script><![CDATA[var app = angular.module("bball", [])
.controller('PlayersController', ['$scope', '$http', function($scope, $http) {
	$scope.game_players_url = '/api/now/table/sn_bball_game_player'; $scope.games_url = '/api/now/table/sn_bball_game'; $scope.players_url = '/api/now/table/sn_bball_game_player';
	$http.defaults.headers.common.Accept = "application/json"; $http.defaults.headers.common['X-UserToken'] = g_ck; $scope.current_player = '';
	$scope.getNextGame = function() { return $http({
		method : 'GET',
		url : $scope.games_url + "?sysparm_query=game_date>javascript:gs.minutesAgoEnd(0)^ORDERBYgame_date&sysparm_limit=1"
	}).success(function(data, status) {
		var gameData = data.result[0];
		$scope.nextGame = gameData.sys_id;
		$scope.weather = gameData.projected_weather;
		$scope.gameTime = gameData.game_date;
	}).error(function(data, status) {
		$scope.lastError = status;
	});
};
$scope.getPlayers = function() {
	$scope.getNextGame().then(function() {
		$http({
			method : 'GET',
			url : $scope.game_players_url + "?sysparm_query=game=" + $scope.nextGame + "^playing=1^ORDERBYDESCgame&sysparm_display_value=true"
		}).success(function(data, status) {
			$scope.optin = data.result;
		}).error(function(data, status) {
			$scope.lastError = status;
		});
	}).then(function() {
		$http({
			method : 'GET',
			url : $scope.game_players_url + "?sysparm_query=game=" + $scope.nextGame + "^playing=0^ORDERBYDESCgame&sysparm_display_value=true"
		}).success(function(data, status) {
			$scope.optout = data.result;
		}).error(function(data, status) {
			$scope.lastError = status;
		});
	});
};
$scope.getCurrentPlayer = function() {
	if (!userId)
		return;
	
	$http({
		method : 'GET',
		url : $scope.players_url + "?sysparm_query=player.player=" + userId + "&sysparm_display_value=true"
	}).success(function(data, status) {
		$scope.current_player = data.result[0].sys_id;
	}).error(function(data, status) {
		$scope.lastError = status;
	});
};
$scope.optInOut = function(playing) {
	if (!userId || ! $scope.current_player || !$scope.nextGame)
		return;
	
	$http({
		method : 'POST',
		url : $scope.game_players_url + "?sysparm_display_value=true", data : {
			game: $scope.nextGame,
			player: $scope.current_player,
			playing: playing
		}
	}).error(function(data, status) {
		$scope.lastError = status;
		//try updating the existing record?
		$http({
			method : 'GET',
			url : $scope.game_players_url + "?sysparm_query=player="+ $scope.current_player +"^game=" + $scope.nextGame + "&sysparm_display_value=true"}).success(function(data, status) {
				$http({
					method : 'PUT',
					url : $scope.game_players_url + "/" +data.result[0].sys_id,
					data : {
						playing : playing
					} 
				});
		}) ;
	});
				$scope.getPlayers();
			} ;
	$scope.getPlayers();
$scope.getCurrentPlayer();
}]);]]></script>
        <script_name>BBallPlayers</script_name>
        <sys_class_name>sys_ui_script</sys_class_name>
        <sys_created_by>tricia.lynch</sys_created_by>
        <sys_created_on>2018-02-19 21:51:27</sys_created_on>
        <sys_id>5eeac507dbd013009962d450cf96197f</sys_id>
        <sys_mod_count>7</sys_mod_count>
        <sys_name>sn_bball.BBallPlayers</sys_name>
        <sys_package display_value="GameTimeNow" source="sn_bball">2811225c9f3112005ca47fc9c42e7022</sys_package>
        <sys_policy/>
        <sys_scope display_value="GameTimeNow">2811225c9f3112005ca47fc9c42e7022</sys_scope>
        <sys_update_name>sys_ui_script_5eeac507dbd013009962d450cf96197f</sys_update_name>
        <sys_updated_by>tricia.lynch</sys_updated_by>
        <sys_updated_on>2018-02-21 20:20:41</sys_updated_on>
        <use_scoped_format>false</use_scoped_format>
    </sys_ui_script>
</record_update>
